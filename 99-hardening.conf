# =============================================================
# 99-hardening.conf
# Comprehensive Linux Kernel Hardening Configuration for Security & Performance Optimization
# Author: xbucd
# Created with guidance from public references and AI tools
# Inspired by general Linux sysctl hardening guides and best practices
# Date Created: November 4, 2025
# Last Updated: November 4, 2025
#
# Applies advanced network stack protection, DoS mitigation, memory/info leak prevention,
# filesystem and process restrictions.
# Provides a safe baseline plus optional advanced tweaks for stricter environments.
#
# Licensed under the GNU General Public License Version 3 (GNU GPL v3), available at: https://www.gnu.org/licenses/gpl-3.0.txt
# Copyright (C) 2025 xbucd and contributors.
# =============================================================

# =============================================================
# üõ°Ô∏è NETWORK STACK (security & routing) - Prevent MITM, spoofing, and routing attacks
# =============================================================

## BASICS
# Routing & spoofing protection
net.ipv4.conf.default.send_redirects = 0            # Do not send ICMP redirects; reduces risk of malicious routing info
net.ipv4.conf.all.send_redirects = 0

net.ipv4.conf.default.accept_redirects = 0          # Ignore ICMP redirect messages; prevents attacker from changing routing (ICMP = Internet Control Message Protocol)
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.secure_redirects = 0

# Reverse path filtering (anti-spoofing)
net.ipv4.conf.default.rp_filter = 1                 # Reverse Path Filter (drops spoofed packets)
net.ipv4.conf.all.rp_filter = 1

# Log suspicious packets to Kernel log
net.ipv4.conf.default.log_martians = 1
net.ipv4.conf.all.log_martians = 1

# Enable1/Disable0 forwarding (if not a router set 0)
net.ipv4.ip_forward = 1                         # Enable packet forwarding (required if host routes traffic between VMs or networks)

## ADVANCED (optional)
net.ipv4.conf.default.accept_source_route = 0   # Drop source-routed packets (prevents routing abuse)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.eno1.accept_source_route = 0
net.ipv4.conf.lo.accept_source_route = 0
net.ipv4.conf.wlan0.accept_source_route = 0

net.ipv4.conf.all.promote_secondaries = 1       # Allow secondary IPs on interfaces (needed for multihomed setups)
net.ipv4.conf.default.promote_secondaries = 1
#net.ipv4.conf.eno1.promote_secondaries = 1
#net.ipv4.conf.lo.promote_secondaries = 1
#net.ipv4.conf.wlan0.promote_secondaries = 1

# IP range & queues
net.ipv4.ip_local_port_range = 1024 65535       # increase system IP port limits
net.core.netdev_max_backlog = 250000            # increases queue length for high-load NICs

# ARP Hardening - behavior (protects against poisoning; prevent spoofing and reduce attack surface)
net.ipv4.conf.default.arp_announce = 2          # always use best local IP for ARP announcements
net.ipv4.conf.all.arp_announce = 2
net.ipv4.conf.default.arp_ignore = 1            # Reply only if target IP matches local interface configured on the incoming interface
net.ipv4.conf.all.arp_ignore = 1

# Drop gratuitous ARP packets to prevent ARP spoofing or cache poisoning.
# waning: set 0 if using VRRP, bonding, or failover setups (they rely on gratuitous ARP).
#net.ipv4.conf.default.drop_gratuitous_arp = 1
#net.ipv4.conf.all.drop_gratuitous_arp = 1

net.ipv4.conf.all.shared_media = 0           # Disable shared media mode; prevents accepting redirects or RAs from non-local networks
net.ipv4.conf.default.shared_media = 0       # Ensures system treats each interface as isolated (not shared Ethernet segment)

###### IPv6 ######
# Optional IPv6 hardening (enable only if IPv6 is not used)
net.ipv6.conf.all.disable_ipv6 = 1             # Disable IPv6 completely
net.ipv6.conf.default.disable_ipv6 = 1
#net.ipv6.conf.lo.disable_ipv6 = 1

# IPv6 ready settings (commented until IPv6 is enabled)
# --------------------------
# ICMP / Redirects
# --------------------------
# ignore IPv6 ICMP redirect messages to prevent malicious routing updates
#net.ipv6.conf.all.accept_redirects = 0
#net.ipv6.conf.default.accept_redirects = 0

# ignore all IPv6 ICMP echo requests
#net.ipv6.icmp.echo_ignore_all = 1
#net.ipv6.icmp.echo_ignore_anycast = 1
#net.ipv6.icmp.echo_ignore_multicast = 1

## ADVANCED (optional)
# --------------------------
# Forwarding / Routing
# --------------------------
# Disable IPv6 packet forwarding (do not act as a router)
#net.ipv6.conf.all.forwarding = 0
#net.ipv6.conf.default.forwarding = 0

# Number of Router Solicitations to send until assuming no routers exist
#net.ipv6.conf.all.router_solicitations = 0
#net.ipv6.conf.default.router_solicitations = 0

# Do not accept router preference from Router Advertisements
#net.ipv6.conf.all.accept_ra_rtr_pref = 0
#net.ipv6.conf.default.accept_ra_rtr_pref = 0

# Do not learn prefix information from Router Advertisements
#net.ipv6.conf.all.accept_ra_pinfo = 0
#net.ipv6.conf.default.accept_ra_pinfo = 0

# Do not accept default router info from Router Advertisements
#net.ipv6.conf.all.accept_ra_defrtr = 0
#net.ipv6.conf.default.accept_ra_defrtr = 0

# Automatically assign global IPv6 addresses from Router Advertisements
#net.ipv6.conf.all.autoconf = 0
#net.ipv6.conf.default.autoconf = 0

# --------------------------
# Addresses / Privacy
# --------------------------
# Maximum number of global IPv6 addresses per interface
#net.ipv6.conf.all.max_addresses = 1
#net.ipv6.conf.default.max_addresses = 1

# Duplicate Address Detection (number of neighbor solicitations per address)
#net.ipv6.conf.all.dad_transmits = 0
#net.ipv6.conf.default.dad_transmits = 0

# Enable IPv6 Privacy Extensions (RFC 3041), prefer temporary addresses
#net.ipv6.conf.all.use_tempaddr = 2
#net.ipv6.conf.default.use_tempaddr = 2

# Do not accept packets with Source Routing option
#net.ipv6.conf.all.accept_source_route = 0
#net.ipv6.conf.default.accept_source_route = 0

# =============================================================
# üí£ DENIAL OF SERVICE (DoS) PROTECTION - PERFORMANCE - TCP HARDENING and ICMP Floods
# =============================================================

## BASICS
net.ipv4.tcp_syncookies = 1                  # SYN cookies; mitigates SYN flood DoS attacks
net.ipv4.icmp_echo_ignore_broadcasts = 1     # Ignore broadcast pings (protects against Smurf attack amplification)

## ADVANCED (optional)
#net.ipv4.icmp_echo_ignore_all = 1          # ignore all ICMP echo requests
net.ipv4.tcp_fin_timeout = 15               # Reduce FIN-WAIT timeout; frees sockets faster (free resources faster)
net.ipv4.tcp_max_syn_backlog = 1024         # Limit SYN backlog queue; prevents overloading connection queue
net.ipv4.icmp_ignore_bogus_error_responses = 1  # Ignore invalid ICMP errors; improves stability; rarely needed, safe
net.ipv4.tcp_keepalive_time = 120           # Adjust TCP keepalive interval (in seconds)
net.core.default_qdisc = fq_codel           # Use fair queueing to reduce latency under load (fq_codel = Fair Queue Controlled Delay)

net.ipv4.tcp_synack_retries = 5             # Number of SYN+ACK retransmissions before giving up; reduces exposure to SYN flood attacks

# TCP tuning
# can cause overhead on congested networks
net.ipv4.tcp_mtu_probing = 1              # Enable automatic path MTU discovery to avoid blackhole issues
net.ipv4.tcp_base_mss = 1024              # Set base MSS to avoid fragmentation on small MTUs

## ‚öôÔ∏è PERFORMANCE & BUFFERING
# Memory / buffer size limits (helps prevent packet loss/dropping)
net.core.rmem_default = 8388608             # Default receive buffer size (8MB)
net.core.wmem_default = 8388608             # Default send buffer size (8MB)
net.core.rmem_max = 536870912               # Max receive buffer (512MB)
net.core.wmem_max = 536870912               # Max send buffer (512MB)
net.core.optmem_max = 40960                 # Max ancillary (control) data buffer
net.ipv4.tcp_rmem = 8192 262144 536870912   # Min/Default/Max TCP read buffer
net.ipv4.tcp_wmem = 4096 16384 536870912    # Min/Default/Max TCP write buffer
net.ipv4.tcp_notsent_lowat = 131072         # Limit unsent data before blocking send() (prevents bufferbloat)
net.ipv4.tcp_adv_win_scale = -2             # Adjust advertised window size to reduce TCP receive queue collapse
# -> https://blog.cloudflare.com/optimizing-tcp-for-high-throughput-and-low-latency

# Congestion control
net.ipv4.tcp_congestion_control = bbr      # modern, faster congestion control - BBR (Bottleneck Bandwidth and RTT) for high-speed, low-latency TCP

# =============================================================
# üß† MEMORY & KERNEL INFO LEAK PROTECTION
# =============================================================

## BASICS
kernel.kptr_restrict = 2                     # Hide kernel pointer addresses from non-root; prevents kernel address leaks
kernel.dmesg_restrict = 1                    # Restrict dmesg access; blocks info leakage from kernel logs (prevents unprivileged users from seeing kernel logs)

## ADVANCED (optional)
# kernel.yama.ptrace_scope = Restrict ptrace to parent processes only; (prevents processes from spying on other processes)
# 0 = no restrictions (ptrace allowed for any process)
# 1 = only parent can ptrace its children (default safe)
# 2 = admin-only ptrace (more strict, reduces debugging ability)
# 3 = no ptrace allowed (maximum restriction, may break debugging tools)
kernel.yama.ptrace_scope = 1

kernel.unprivileged_bpf_disabled = 1         # Only root can run eBPF programs; prevents unprivileged code execution
#net.core.bpf_jit_harden = 2                 # hardens JIT, prevents JIT spraying (minor perf cost)

kernel.randomize_va_space = 2                # Full Address Space Layout Randomization (ASLR): randomize stack, heap, mmap, and brk base

kernel.kexec_load_disabled = 1               # Disable kexec to prevent loading or live-patching kernel images; prevent rootkit / persistence risk

#kernel.pid_max = 4194304                    # Increase max PID; needed for very large process counts (DB server)
kernel.sysrq = 0                             # Limit sysrq key usage; disables dangerous debug commands (SysRq = System Request key); set 16 or 0

kernel.perf_event_paranoid = 3               # Restrict access to performance counters to root only (prevents side-channel attacks)
kernel.perf_cpu_time_max_percent = 1         # Limit CPU time used by the perf subsystem to 1% (reduces overhead and leak risk)
kernel.perf_event_max_sample_rate = 1        # Reduce perf sample rate to mitigate speculative execution leaks

dev.tty.ldisc_autoload = 0                   # Block unprivileged loading of TIOCSETD vulnerable line disciplines
dev.tty.legacy_tiocsti = 0                   # Disable TIOCSTI - prevents keypress injection (can break screen readers)

# üí• KERNEL PANIC / FAILSAFE REBOOTS
#kernel.panic = 10                  # Reboot automatically 10s after a kernel panic (useful for remote systems)
#kernel.warn_limit = 1              # Optional: reboot after one kernel warning
#kernel.oops_limit = 1              # Optional: reboot after one kernel oops


# =============================================================
# üß± CORE DUMPS & LOGGING
# =============================================================

## BASICS
# üîß Core dump / logging a Process / Kernel Protections
kernel.core_pattern = "|/usr/lib/systemd/systemd-coredump %P %u %g %s %t %c %h %d %F"  # Pipe core dumps to systemd-coredump
kernel.core_pipe_limit = 16                 # Limit number of parallel core dumps
kernel.core_uses_pid = 1                    # Append PID to core filenames for uniqueness

## ADVANCED (optional)
fs.suid_dumpable = 0                        # Disable core dumps of SUID binaries (prevents leaking privileged memory)

# =============================================================
# üìÇ FILESYSTEM PROTECTIONS
# =============================================================

## ADVANCED (optional)
fs.protected_hardlinks = 1                  # Prevent hardlink attacks (non-owner users cannot link sensitive files)
fs.protected_symlinks = 1                   # Prevent symlink attacks in world-writable directories
fs.protected_regular = 2                    # Protect regular files in shared directories
fs.protected_fifos = 2                      # Protect FIFO (named pipe) special files

## Optional Tunables - good for performance
fs.file-max = 9223372036854775807           # Increase system-wide max file descriptors (more open files/sockets system-wide)
fs.inotify.max_user_watches = 524288        # Increases how many files a user can watch for changes (used by tools like VSCode, file sync apps, Docker, Monitoring, etc.)

# =============================================================
# ‚öôÔ∏è OPTIONAL SITUATIONAL TWEAKS
# =============================================================
# Only enable if you know what they do or need them for tuning.
# They are safe but might affect performance, debugging, or advanced networking.

net.ipv4.tcp_rfc1337 = 1                     # Protect against TIME-WAIT assassination (RFC 1337)
#vm.swappiness = 10                           # Reduce swap tendency for better responsiveness
vm.max_map_count = 1048576                   # Increase virtual memory maps (useful for databases or VMs)

#kernel.deny_new_usb=1                        # block all new connected USB devices

#net.ipv4.tcp_slow_start_after_idle = 0       # Disable slow start after idle (use 1 for LTE/mobile, 0 for stable wired networks)

#net.ipv4.tcp_timestamps = 0                  # Disable TCP timestamps to prevent OS fingerprinting and uptime leaks (set 1 for better throughput on high-latency links); RFC1323

#kernel.unprivileged_userns_clone = 0         # Disable unprivileged user namespaces; blocks sandboxing for apps like Firefox, Chrome, Docker
#user.max_user_namespaces = 0                 # Completely disables creation of user namespaces

#net.ipv4.tcp_window_scaling = 0              # anti-DDoS: disable TCP window scaling (reduces susceptibility to certain RST/DoS attacks; may greatly reduce throughput on high-latency links)

#kernel.modules_disabled = 1                  # Prevent runtime loading of kernel modules (improves security, may break drivers; consider applying manually after boot)

# =============================================================
# üñ•Ô∏è VIRTUALIZATION & MMAP HARDENING
# =============================================================
## ADVANCED (optional)

vm.mmap_min_addr = 65536                       # Block mmap below this address for security (prevents NULL pointer attacks)
vm.mmap_rnd_bits = 32                          # Randomize mmap addresses for ASLR effectiveness
vm.mmap_rnd_compat_bits = 16                   # Improve mmap ASLR compatibility

#vm.unprivileged_userfaultfd = 0               # Restrict userfaultfd (affects some VM/container features)
vm.unprivileged_userfaultfd = 1               # Restrict unprivileged userfaultfd; mitigates memory-based privilege escalation

