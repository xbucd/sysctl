# =============================================================
# 99-rpi.conf
# Secure and optimized sysctl configuration for Raspberry Pi 5
# Author: xbucd
# Target: Raspberry Pi OS Lite (arm64)
# Created: November 12, 2025
# Version: 1.1
#
# Focused on practical kernel-level security, DoS resistance,
# memory leak prevention and lightweight network hardening
# specifically tuned for ARM-based SBC devices.
#
# Licensed under GNU GPLv3 â€” https://www.gnu.org/licenses/gpl-3.0.txt
# =============================================================


# =============================================================
# NETWORK STACK PROTECTION
# =============================================================

# Prevent ICMP redirect and source route spoofing
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0

# Enable reverse path filtering (anti-spoofing)
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# Log suspicious packets (martians)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# Disable IPv6 if not required
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1

# Optional: disable IP forwarding (device is not router)
net.ipv4.ip_forward = 0

# =============================================================
# BASIC DOS & NETWORK PERFORMANCE
# =============================================================

# SYN flood protection
net.ipv4.tcp_syncookies = 1
net.ipv4.icmp_echo_ignore_broadcasts = 1
net.ipv4.icmp_ignore_bogus_error_responses = 1

# Connection and timeout tuning
net.ipv4.tcp_fin_timeout = 15
net.ipv4.tcp_max_syn_backlog = 1024

# Congestion control (modern, stable)
net.ipv4.tcp_congestion_control = bbr

# Fair queuing for smoother latency under load
net.core.default_qdisc = fq_codel


# =============================================================
# MEMORY, KERNEL, AND LEAK PROTECTION
# =============================================================

# Hide kernel pointers and restrict kernel logs
kernel.kptr_restrict = 2
kernel.dmesg_restrict = 1

# Prevent unauthorized process debugging
kernel.yama.ptrace_scope = 1

# Disable kernel image loading to prevent persistence/rootkits
kernel.kexec_load_disabled = 1

# Restrict low-level access and system requests
kernel.sysrq = 0
kernel.perf_event_paranoid = 3

# Randomize memory layout (ASLR)
kernel.randomize_va_space = 2


# =============================================================
# FILESYSTEM & EXECUTION SAFETY
# =============================================================

# Prevent hardlink and symlink privilege escalation
fs.protected_hardlinks = 1
fs.protected_symlinks = 1

# Disable SUID core dumps (avoid sensitive memory leaks)
fs.suid_dumpable = 0

# Strengthen file safety in shared dirs (optional)
fs.protected_regular = 2
fs.protected_fifos = 2


# =============================================================
# TERMINAL, INPUT & DEVICE SECURIT
# =============================================================

# Prevent key injection via TIOCSTI (rare privilege escalation vector)
dev.tty.legacy_tiocsti = 0

# Block dynamic line discipline loading (kernel modules exploit path)
dev.tty.ldisc_autoload = 0


# =============================================================
# MEMORY MAPPING & ADDRESS RANDOMIZATION
# =============================================================

# Prevent NULL pointer dereference attacks
vm.mmap_min_addr = 65536

# Improve address space randomization for ARM64
vm.mmap_rnd_bits = 32
vm.mmap_rnd_compat_bits = 16


# =============================================================
# SAFE OPTIONAL TWEAKS
# =============================================================

# Reduce swap usage for faster responsiveness
vm.swappiness = 10

# Protect against TIME-WAIT assassination attacks
net.ipv4.tcp_rfc1337 = 1

# Disable user BPF programs (prevents local privilege escalation)
kernel.unprivileged_bpf_disabled = 1
